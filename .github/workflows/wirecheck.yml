name: Finityo Wiring Agent
on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:

jobs:
  wirecheck:
    name: Wiring Integrity Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Run Wiring Integrity Scan
        id: scan
        run: |
          echo "üîç Running wiring integrity scan..."

          node << 'EOF'
          // ==============================================================
          //  FINITYO WIRING INTEGRITY CHECK ENGINE
          //  Ensures ALL engine usage flows through unified engine ONLY.
          //  Flags:
          //    - Legacy computeDebtPlan usage
          //    - PlanContext usage outside LivePlanContext
          //    - Direct imports from @/engine/* except allowed modules
          //    - Banned hooks
          // ==============================================================

          const fs = require("fs");
          const path = require("path");

          const ROOT = process.cwd();
          const ALLOWED_ENGINE_IMPORTS = [
            "@/engine/useUnifiedPlan",
            "@/engine/unified-engine",
            "@/engine/plan-types",
            "@/engine/compat/compatLayer",
          ];

          const BANNED_PATTERNS = [
            { pattern: "computeDebtPlan(", issue: "Legacy computeDebtPlan() detected. Must use computeDebtPlanUnified()." },
            { pattern: "PlanContext", issue: "Legacy PlanContext detected. Must use LivePlanContext + useUnifiedPlan()." },
            { pattern: "usePlan()", issue: "Legacy usePlan() hook detected. Must use useUnifiedPlan()." },
            { pattern: "from '@/engine/", issue: "Direct engine import detected. Must use allowed unified engine modules only." },
          ];

          const ALLOWED_ENGINE_IMPORT_SNIPPETS = ALLOWED_ENGINE_IMPORTS.map(x => `from '${x}`);

          const violations = [];

          function scanFile(filePath) {
            const content = fs.readFileSync(filePath, "utf8");

            // Check banned patterns
            for (const ban of BANNED_PATTERNS) {
              if (content.includes(ban.pattern)) {
                violations.push({
                  file: filePath,
                  issue: ban.issue,
                  pattern: ban.pattern,
                });
              }
            }

            // Check engine import misuse
            if (content.includes("from '@/engine/")) {
              const safe = ALLOWED_ENGINE_IMPORT_SNIPPETS.some(s => content.includes(s));
              if (!safe) {
                violations.push({
                  file: filePath,
                  issue: "Direct import from @/engine detected. Must route through unified engine.",
                });
              }
            }
          }

          function walk(dir) {
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              if (["node_modules", ".git", ".github", "dist", "build", "supabase"].includes(entry.name)) continue;
              const fullPath = path.join(dir, entry.name);
              if (entry.isDirectory()) walk(fullPath);
              else if (fullPath.endsWith(".ts") || fullPath.endsWith(".tsx")) scanFile(fullPath);
            }
          }

          walk(path.join(ROOT, "src"));

          if (violations.length > 0) {
            console.log("‚ùå Wiring violations found:\n");
            violations.forEach(v => {
              console.log(`FILE: ${v.file}\nISSUE: ${v.issue}\nPATTERN: ${v.pattern ?? "n/a"}\n`);
            });
            fs.writeFileSync("wirecheck-report.json", JSON.stringify(violations, null, 2));
            process.exit(1);
          } else {
            console.log("‚úÖ Wiring is fully clean. No violations found.");
          }
          EOF

      - name: Upload Wirecheck Report (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: wirecheck-report
          path: wirecheck-report.json

      - name: Auto-create Fix PR
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Fix wiring violations"
          branch: wiring-fixes
          title: "Automated Wiring Fixes"
          body: |
            The Finityo Wiring Agent detected wiring issues and generated fixes.
            Please review and approve.
