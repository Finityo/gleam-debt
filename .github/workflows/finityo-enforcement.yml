# .github/workflows/finityo-enforcement.yml
# Finityo Architectural Enforcement Pipeline
# This CI job HARD FAILS on any guard or audit violation

name: Finityo Enforcement Gate

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches: [ "main" ]

jobs:
  enforcement:
    name: Runtime Guards + Wiring Audit Enforcement
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout Repo
        uses: actions/checkout@v4

      - name: ‚úÖ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ‚úÖ Install Dependencies
        run: npm ci

      # ----------------------------------------
      # 1Ô∏è‚É£ Type Safety (Catches Guard Drift)
      # ----------------------------------------
      - name: ‚úÖ Type Check
        run: npm run typecheck

      # ----------------------------------------
      # 2Ô∏è‚É£ Lint (Catches Illegal Direct Routing)
      # ----------------------------------------
      - name: ‚úÖ Lint
        run: npm run lint

      # ----------------------------------------
      # 3Ô∏è‚É£ Run Guard + Audit Smoke Tests
      # ----------------------------------------
      - name: üß™ Run Enforcement Smoke Test
        run: |
          echo "Running Finityo Enforcement Smoke Test..."
          npm test -- tests/finityoViolationSmokeTest.ts

      # ----------------------------------------
      # 4Ô∏è‚É£ HARD FAIL ON ANY VIOLATION OUTPUT
      # ----------------------------------------
      - name: üö® Block on Guard or Audit Failure
        if: failure()
        run: |
          echo "‚ùå FINITYO ARCHITECTURE VIOLATION DETECTED"
          echo "‚ùå Guards, Audit, or Agents flagged illegal behavior."
          echo "‚ùå Deployment is BLOCKED."
          exit 1

      # ----------------------------------------
      # 5Ô∏è‚É£ PASS CONFIRMATION
      # ----------------------------------------
      - name: ‚úÖ Enforcement Passed
        if: success()
        run: |
          echo "‚úÖ Finityo Enforcement Passed"
          echo "‚úÖ Guards OK"
          echo "‚úÖ Wiring Audit OK"
          echo "‚úÖ Navigation Authority OK"
          echo "‚úÖ Compare Sandbox OK"
